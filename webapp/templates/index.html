<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Content Assistant</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; height: 100vh; overflow: hidden; background: #0f1117; color: #e4e4e7; }
        .chat-container { display: flex; flex-direction: column; height: 100vh; }
        .chat-header { background: #18181b; border-bottom: 1px solid #27272a; padding: 1rem 1.5rem; display: flex; align-items: center; gap: 0.75rem; flex-shrink: 0; }
        .rocket-icon { width: 28px; height: 28px; color: #a78bfa; }
        .chat-header h1 { font-size: 1.25rem; font-weight: 600; color: #fafafa; }
        .messages-container { flex: 1; overflow-y: auto; padding: 2rem 1rem; display: flex; flex-direction: column; gap: 1.5rem; }
        .messages-container::-webkit-scrollbar { width: 8px; }
        .messages-container::-webkit-scrollbar-track { background: #18181b; }
        .messages-container::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 4px; }
        .message { display: flex; gap: 0.75rem; max-width: 800px; animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message.user { margin-left: auto; flex-direction: row-reverse; }
        .message-avatar { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-weight: 600; font-size: 0.875rem; }
        .message.user .message-avatar { background: #7c3aed; color: white; }
        .message.assistant .message-avatar { background: #27272a; color: #a78bfa; }
        .message-content { background: #18181b; padding: 1rem; border-radius: 1rem; border: 1px solid #27272a; line-height: 1.6; word-wrap: break-word; white-space: pre-wrap; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word;}
        .message.user .message-content { background: #7c3aed; border-color: #7c3aed; color: white; }
        .empty-state { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 1rem; color: #71717a; text-align: center; padding: 2rem; }
        .empty-state-icon { width: 64px; height: 64px; opacity: 0.5; }
        .input-container { border-top: 1px solid #27272a; background: #18181b; padding: 1.5rem; flex-shrink: 0; }
        .input-wrapper { max-width: 800px; margin: 0 auto; display: flex; gap: 0.75rem; align-items: flex-end; }
        .textarea-wrapper { flex: 1; position: relative; }
        textarea { width: 100%; min-height: 56px; max-height: 200px; padding: 1rem; border: 1px solid #3f3f46; border-radius: 0.75rem; background: #0f1117; color: #e4e4e7; font-size: 1rem; font-family: inherit; resize: none; outline: none; transition: border-color 0.2s; }
        textarea:focus { border-color: #7c3aed; }
        textarea::placeholder { color: #52525b; }
        .send-button { height: 56px; width: 56px; background: #7c3aed; border: none; border-radius: 0.75rem; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; flex-shrink: 0; }
        .send-button:hover:not(:disabled) { background: #6d28d9; }
        .send-button:active { transform: scale(0.95); }
        .send-button:disabled { background: #3f3f46; cursor: not-allowed; opacity: 0.5; }
        .send-icon { width: 20px; height: 20px; }
        @media (max-width: 640px) { .chat-header { padding: 1rem; } .messages-container { padding: 1rem; } .input-container { padding: 1rem; } }
        pre code.hljs { display: block; overflow-x: auto; padding: 1em; background: #282c34; border-radius: 0.5rem; }
        .status-line { font-style: italic; color: #a1a1aa; font-size: 0.875rem; margin-bottom: 0.5rem; animation: fadeIn 0.5s ease-in; }
    </style>
</head>
<body>
  {% raw %}
  <div id="app" class="chat-container">
    <header class="chat-header">
      <svg class="rocket-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
      <h1>AI Content Assistant</h1>
    </header>
    <div class="messages-container" ref="messagesContainer">
      <div v-if="messages.length === 0" class="empty-state">
        <svg class="empty-state-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
        <p>Start a conversation with your AI Content Assistant</p>
      </div>
      <div v-for="(msg, index) in messages" :key="index" class="message" :class="{'user': msg.isUser, 'assistant': !msg.isUser}">
        <div class="message-avatar">{{ msg.isUser ? 'U' : 'AI' }}</div>
        <div class="message-content" v-html="renderMarkdown(msg.text)"></div>
      </div>
    </div>
    <div class="input-container">
      <form @submit.prevent="sendMessage" class="input-wrapper">
        <div class="textarea-wrapper">
          <textarea v-model="userInput" @keydown.enter.prevent.exact="sendMessage" placeholder="Type your message here..." rows="1" :disabled="isLoading" ref="userInput"></textarea>
        </div>
        <button type="submit" class="send-button" :disabled="isLoading">
          <svg class="send-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" /></svg>
        </button>
      </form>
    </div>
  </div>
  {% endraw %}
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script>
    marked.setOptions({ breaks: true, gfm: true, mangle: false, headerIds: false });
    const { createApp, nextTick } = Vue;
    createApp({
      data() {
        return {
          messages: [],
          userInput: '',
          isLoading: false,
          sessionId: 'session_' + Date.now() + Math.random().toString(36).substring(2)
        };
      },
      watch: {
        messages: {
          handler() {
            nextTick(() => {
              this.$el.querySelectorAll('pre code:not(.hljs)').forEach((block) => { hljs.highlightElement(block); });
              this.scrollToBottom();
            });
          },
          deep: true
        }
      },
      methods: {
        renderMarkdown(text) { return text ? marked.parse(text) : ''; },
        scrollToBottom() { const container = this.$refs.messagesContainer; if (container) container.scrollTop = container.scrollHeight; },
        async sendMessage() {
          const userMessage = this.userInput.trim();
          if (!userMessage || this.isLoading) return;
          this.messages.push({ text: userMessage, isUser: true });
          this.userInput = '';
          this.isLoading = true;
          this.$refs.userInput.style.height = 'auto';
          const aiMessageIndex = this.messages.push({ text: '<div class="status-line">AI 正在准备...</div>', isUser: false }) - 1;
          try {
            const response = await fetch('/chat', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ prompt: userMessage, session_id: this.sessionId }),
            });
            if (!response.ok) throw new Error(`服务器错误: ${response.status}`);
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let isAnswerSection = false;
            let currentMessage = this.messages[aiMessageIndex];
            while (true) {
              const { value, done } = await reader.read();
              if (done) break;
              const chunk = decoder.decode(value, { stream: true });
              const lines = chunk.split('\n').filter(line => line.trim() !== '');
              for (const line of lines) {
                if (line.trim() === '答案：') {
                  isAnswerSection = true;
                  currentMessage.text = '';
                  continue;
                }
                if (isAnswerSection) {
                  currentMessage.text += line;
                } else {
                  if (currentMessage.text.includes('status-line')) {
                    currentMessage.text = `<div class="status-line">${line}</div>`;
                  } else {
                    currentMessage.text += `<div class="status-line">${line}</div>`;
                  }
                }
              }
            }
          } catch (error) {
            console.error('调用API失败:', error);
            this.messages[aiMessageIndex].text = `出错了: ${error.message}`;
          } finally {
            this.isLoading = false;
            nextTick(() => this.$refs.userInput.focus());
          }
        }
      }
    }).mount('#app');
  </script>
</body>
</html>